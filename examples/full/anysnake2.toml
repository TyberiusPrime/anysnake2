# fully featured anysnake2.toml example
[anysnake2]
# We leverage nix flakes to run exactly that version.
rev = "dev" # replace with fixed version outside of tests/examples
# rev = "dev" = do not switch to fixed version, used in development.

# use_binary = true; default, optional, switches the default url. Ignored if url = is set.

# The rev must be a tag or sha-hash from the following configured url.
# url = "https://github.com/TyberiusPrime/anysnake2_release_flakes" # if you want to override this.
# (if use_binary is false, the default is  https://github.com/TyberiusPrime/anysnake2), 
# and there will be a rust build step involved.

# do_not_modify_flake = true # if set to true,
                             # flake/flake.nix is never overwritten,
							 # but stored in flake/flake.generated.nix.
							 # And nix build is called every run
							 # This is an escape hatch.

[dev_shell] # optional
    shell = "fish" # optional
	inputs = [ # optional
		# these are packages that show up only when you do 'nix develop'
		"rust-analyzer"
	]

[outside_nixpkgs]
# the nixpkgs used to run singularity and nixfmt
rev = "21.05"

[nixpkgs]
rev = "21.05" # the nixpgks version or github hash
# rev = "7e9b0dff974c89e070da1ad85713ff3c20b0ca97"
# url = "git+https://github.com/NixOS/nixpkgs" # optional
# url = "github:NixOS/nixpkgs" # prefer the github variant for then we can lookup tags.
packages = [ # use https://search.nixos.org/packages to search
	"fish",
	"netcat"] # optional

[flake-util]
# the revision used by flake-util
# rev = "7e5bf3925f6fbdfaf50a2a7ca0be2879c4261d19" # optional
# url = "github:/oxalica/rust-overlay"

[mach-nix]
# the revision used by flake-util
# rev = "dc94135e31d5c90c40a00a6cbdf9330526e8153b" # optional
# url = "github:/DavHau/mach-nix"



[python] # python section is optional
version="3.8" # does not go down to 3.8.x. That's implicit in the nixpkgs (for now)
ecosystem_date="2021-10-11" # you get whatever packages the solver would have produced on that day

[python.packages]
# you can use version specifiers from https://www.python.org/dev/peps/pep-0440/#id53
scipy=""
pypipegraph2=">2."
dppd = "editable/code"
dppd_plotnine = "editable/code"
# pandas="<1.0"

[clones.code] # target directory
# seperate from python packages so you can clone other stuff as well
dppd="@gh/TyberiusPrime" # one /-> github.com/TyberiusPrime/dppd
dppd_plotnine="@gh/TyberiusPrime/dppd_plotnine"


[R] # R section is optional
ecosystem_tag="2021-10-28_1" # you get whatever packages were current that day.
# r_ecosystem_track_url= "github:TyberiusPrime/r_ecosystem_track" # optional
packages = [
	"ggplot2",
	"affy",
	]

[flakes.hello]
	url = "github:/TyberiusPrime/hello_flake" #https://nixos.wiki/wiki/Flakes#Input_schema - relative paths are tricky
	rev = "f32e7e451e9463667f6a1ddb7a662ec70d35144b" # flakes.lock tends to update unexpectedly, so we tie it down here
	# you can use an url like $ANYSNAKE2_ROOT/path/to/flake for local flakes
	# $ANYSNAKE2_ROOT will be replaced by abspath('anysnake2.toml') (or whatever your config file is)
	follows = ["nixpkgs"] # so we overwrite the flakes dependencies
	packages = ["defaultPackage.x86_64-linux"]

[rust]
# version/rust section is optional. leave of for no rust
version = "1.55.0" # =stable. 
#i to use nightly, add to nipkgs.packages 'rust-bin.nightly."2020-01-01".default'
# rust_overlay_rev = "08de2ff90cc08e7f9523ad97e4c1653b09f703ec" #https://github.com/oxalica/rust-overlay, optional
# rust_overlay_url = "github:oxalica/rust-overlay"


[container]
home = "$HOME/singularity_home/$USER" # where to locate the singularity home. Defaults to $HOME
dtach = true # whether to run your container wrapped in dtach https://github.com/crigler/dtach

[container.volumes_ro]
"/opt" = "/opt"
"/machine/opt/infrastructure/client/anysnake/ssh_host_ecdsa_key" = "/etc/ssh/ssh_host_ecdsa_key"
"/machine/opt/infrastructure/client/anysnake/ssh_host_ed25519_key" = "/etc/ssh/ssh_host_ed25519_key"
"/machine/opt/infrastructure/client/anysnake/ssh_host_rsa_key" = "/etc/ssh/ssh_host_rsa_key"


[container.volumes_rw]
# home get's special treatment, see first line
"." = "/project"
"/var/run/docker.sock" = "/var/run/docker.sock"


[env]
MBF_EXTERNAL_PREBUILD_PATH="/machine/ffs/prebuild/externals/"
MBF_EXTERNAL_HOSTNAME = "${NICE_HOSTNAME}"
MBF_AUTH_USER = "feed"
MBF_AUTH_PASSWORD = "feed"


[cmd.default]
run = """
echo 'run_inside'
set -x # show what we're executing
cd /project
echo 'pythonpath $PYTHONPATH'
python run.py
hello
no_such-command
"""

# the post run runs even if the run failed
post_run_inside = """
echo "post run inside - status was $ANYSNAKE_RUN_STATUS"
"""

# if this one fails, execution stops
pre_run_outside = """
echo "pre run outside"
"""

# runs independend of the sucess inside
post_run_outside = """
echo 'post run outside'
"""

[cmd.shell]
run = """fish
"""

[cmd.jupyter]
run = """
jupyter
"""
# ports are exposed by default (using host network!)


[clone_regexps]
"@gh/([^/]+)"="git+https://github.com/\\1/\\0"
"@gh/([^/]+/[^/]+)"="git+https://github.com/\\1/"


